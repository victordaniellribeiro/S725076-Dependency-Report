<!DOCTYPE html>
<html>
<head>
    <title>S725076-Dependency-Report</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_projectId:void 0,_mapProjects:void 0,_releaseId:void 0,_releaseName:void 0,_iterationId:void 0,_iterationName:void 0,_searchParameter:void 0,_storiesFilter:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;this._projectId=e,console.log("Project:",this._projectId),this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this});var t=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:400,itemId:"releasaeComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._releaseId=t.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},select:function(e,t){var a=t[0];this._releaseId=a.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},scope:this}}),a=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Choose Iteration",width:400,itemId:"iterationComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._iterationId=t.get("ObjectID"),this._iterationName=t.get("Name")},select:function(e,t,a){var r=t[0];this._iterationId=r.get("ObjectID"),this._iterationName=r.get("Name")},scope:this}}),r=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch()}});this.down("#header").add([{xtype:"panel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Filter:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"radiogroup",items:[{xtype:"radiofield",id:"radio1",name:"parameter",boxLabel:"Features",padding:"0 10 0 0",inputValue:"f"},{id:"radio2",name:"parameter",boxLabel:"Stories",padding:"0 10 0 0",inputValue:"s"}],listeners:{change:function(e,r,o){var s=r.parameter;this._searchParameter=s,console.log("value radio:",s);var i=Ext.ComponentQuery.query("#storiesRadioFilter")[0];"f"===s?(t.show(),a.hide(),i.hide()):"s"===s?(i.show(),Ext.ComponentQuery.query("#releaseRadio")[0].setValue("r")):(t.hide(),a.hide(),i.hide())},scope:this}},{xtype:"radiogroup",id:"storiesRadioFilter",fieldLabel:"Choose",columns:2,vertical:!0,items:[{boxLabel:"Release",id:"releaseRadio",name:"storiesFilter",padding:"0 10 0 0",inputValue:"r"},{boxLabel:"Iteration",id:"iteartionRadio",name:"storiesFilter",padding:"0 10 0 0",inputValue:"i"}],listeners:{change:function(e,r,o){var s=r.storiesFilter;this._storiesFilter=s,console.log("value radio:",s),"r"===s?(t.show(),a.hide()):"i"===s?(t.hide(),a.show()):(t.hide(),a.hide())},scope:this}}]}]},{xtype:"panel",items:[t,a,r]}]),Ext.ComponentQuery.query("#storiesRadioFilter")[0].hide(),t.hide(),a.hide()},_doSearch:function(){this.myMask.show();var e=this._getTypes(),t=this._getFilters();Ext.create("Rally.data.wsapi.artifact.Store",{models:e,filters:t,fetch:["Name","FormattedID","ScheduleState","Owner","Project","Predecessors","Successors"],limit:1/0,context:{project:"/project/"+this._projectId,projectScopeUp:!1,projectScopeDown:!0},sorters:[{property:"FormattedID",direction:"ASC"}]}).load().then({success:function(e){if(console.log("records",e),e&&e.length>0){var t=[];_.each(e,function(e){var a=e.get("Predecessors"),r=a.Count,o=e.get("Successors"),s=o.Count;if(a&&r>0){var i=Ext.create("Deft.Deferred");t.push(i);var d=this._loadPredecessors(e);Deft.Promise.all(d).then({success:function(t){console.log("p loaded for:",a),e.get("Predecessors").data=t,i.resolve()},failure:function(e){console.log("error:",e)},scope:this})}if(o&&s>0){var n=Ext.create("Deft.Deferred");t.push(n);var l=this._loadSuccessors(e);Deft.Promise.all(l).then({success:function(t){console.log("s loaded for:",o),e.get("Successors").data=t,n.resolve()},failure:function(e){console.log("error:",e)},scope:this})}},this),Deft.Promise.all(t).then({success:function(){console.log("all artifacts loaded with predecessors and successors"),this.myMask.hide(),this._createGrid(e)},failure:function(e){console.log("error:",e)},scope:this})}else this.myMask.hide()},scope:this})},_getTypes:function(){var e=[];return"f"===this._searchParameter?e.push("PortfolioItem/Feature"):e.push("HierarchicalRequirement"),e},_getFilters:function(){var e;"f"===this._searchParameter?e=Ext.create("Rally.data.QueryFilter",{property:"Release.name",operator:"=",value:this._releaseName}):e="r"===this._storiesFilter?Ext.create("Rally.data.QueryFilter",{property:"Release.name",operator:"=",value:this._releaseName}):Ext.create("Rally.data.QueryFilter",{property:"Iteration.Name",operator:"=",value:this._iterationName});var t=Ext.create("Rally.data.QueryFilter",{property:"Predecessors.ObjectID",operator:"!=",value:"null"});return e.and(t)},_createGrid:function(e){console.log("Creating grid with artifacts",e),this.down("#bodyContainer").removeAll();var t=[];"f"===this._searchParameter?_.each(e,function(e){e.get("Predecessors")&&e.get("Predecessors").data?_.each(e.get("Predecessors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Type:"P",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),Release:a.get("Release")?a.get("Release").Name:"",State:a.get("State")?a.get("State").Name:""})},this):t.push({FormattedID:e.get("FormattedID")+" "+e.get("Name"),Type:"P",DependentFeature:e.get("Predecessors").data,Release:e.get("Release")?e.get("Release").Name:"",State:e.get("State")}),e.get("Successors")&&e.get("Successors").data?_.each(e.get("Successors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Type:"S",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),Release:a.get("Release")?a.get("Release").Name:"",State:a.get("State")?a.get("State").Name:""})},this):t.push({FormattedID:e.get("FormattedID")+" "+e.get("Name"),Type:"S",DependentFeature:e.get("Successors").data,Release:e.get("Release")?e.get("Release").Name:"",State:e.get("State")})},this):_.each(e,function(e){e.get("Predecessors")&&e.get("Predecessors").data?_.each(e.get("Predecessors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Type:"P",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),Release:a.get("Release")?a.get("Release").Name:"",Iteration:a.get("Iteration")?a.get("Iteration").Name:"",State:a.get("ScheduleState")?a.get("ScheduleState"):""})},this):t.push({FormattedID:e.get("FormattedID")+" "+e.get("Name"),Type:"P",DependentFeature:e.get("Predecessors").data,Release:e.get("Release")?e.get("Release").Name:"",Iteration:e.get("Iteration")?e.get("Iteration").Name:"",State:e.get("ScheduleState")}),e.get("Successors")&&e.get("Successors").data?_.each(e.get("Successors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Type:"S",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),Release:a.get("Release")?a.get("Release").Name:"",Iteration:a.get("Iteration")?a.get("Iteration").Name:"",State:a.get("ScheduleState")?a.get("ScheduleState"):""})},this):t.push({FormattedID:e.get("FormattedID")+" "+e.get("Name"),Type:"S",DependentFeature:e.get("Predecessors").data,Release:e.get("Release")?e.get("Release").Name:"",Iteration:e.get("Iteration")?e.get("Iteration").Name:"",State:e.get("ScheduleState")})},this);var a,r=Ext.create("Ext.data.JsonStore",{fields:["FormattedID","Type","DependentFeature","Release","Iteration","State"],data:t});a="f"===this._searchParameter?[{text:"Feature #",dataIndex:"FormattedID",flex:3},{text:"Dependent P/S",dataIndex:"Type",flex:1},{text:"Dependent Feature #",dataIndex:"DependentFeature",flex:3},{text:"Dependent Release",dataIndex:"Release",flex:1},{text:"Dependent State",dataIndex:"State",flex:1}]:[{text:"Story #",dataIndex:"FormattedID",flex:3},{text:"Dependent P/S",dataIndex:"Type",flex:1},{text:"Dependent Story #",dataIndex:"DependentFeature",flex:3},{text:"Dependent Release",dataIndex:"Release",flex:1},{text:"Dependent Iteration",dataIndex:"Iteration",flex:1},{text:"Dependent State",dataIndex:"State",flex:1}];var o=Ext.create("Ext.grid.Panel",{itemId:"featuresGrid",store:r,viewConfig:{enableTextSelection:!0},columns:a}),s=Ext.create("Ext.panel.Panel",{title:"Features Dependency",autoScroll:!0,layout:{type:"vbox",align:"stretch"},padding:5,items:[o]});this.down("#bodyContainer").add(s)},_loadPredecessors:function(e){var t=Ext.create("Deft.Deferred");return e.getCollection("Predecessors").load({fetch:["Name","FormattedID","ScheduleState","State","Project","PlanEstimate","LeafStoryPlanEstimateTotal","Release","Iteration"],callback:function(e,a,r){t.resolve(e)}}),t.promise},_loadSuccessors:function(e){var t=Ext.create("Deft.Deferred");return e.getCollection("Successors").load({fetch:["Name","FormattedID","ScheduleState","State","Project","PlanEstimate","LeafStoryPlanEstimateTotal","Release","Iteration"],callback:function(e,a,r){t.resolve(e)}}),t.promise}});

            Rally.launchApp('CustomApp', {
                name:"S725076-Dependency-Report",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
