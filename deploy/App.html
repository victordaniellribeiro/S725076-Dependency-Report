<!DOCTYPE html>
<html>
<head>
    <title>S725076-Dependency-Report</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_projectId:void 0,_mapProjects:void 0,_releaseId:void 0,_releaseName:void 0,_iterationId:void 0,_iterationName:void 0,_searchParameter:"f",_storiesFilter:void 0,_featureStateExclude:void 0,_dependentFeatureStateExclude:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;this._projectId=e,console.log("Project:",this._projectId),this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this});var t=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:400,itemId:"releasaeComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._releaseId=t.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},select:function(e,t){var a=t[0];this._releaseId=a.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},scope:this}}),a=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Choose Iteration",width:400,itemId:"iterationComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._iterationId=t.get("ObjectID"),this._iterationName=t.get("Name")},select:function(e,t,a){var o=t[0];this._iterationId=o.get("ObjectID"),this._iterationName=o.get("Name")},scope:this}}),o={xtype:"rallyfieldvaluecombobox",fieldLabel:"Exclude Feature States",id:"excludedStatesComboBox",defaultSelectionPosition:"none",multiSelect:!0,model:"PortfolioItem/Feature",field:"State",scope:this,listeners:{change:function(e){console.log("Feature State: ",e.lastSelection),this._featureStateExclude=e.lastSelection},scope:this}},r={xtype:"rallyfieldvaluecombobox",fieldLabel:"Exclude Dependent Feature States",id:"excludedDependentStatesComboBox",multiSelect:!0,defaultSelectionPosition:"none",model:"PortfolioItem/Feature",field:"State",scope:this,listeners:{change:function(e){console.log("Dependent Feature State: ",e.lastSelection),this._dependentFeatureStateExclude=e.lastSelection},scope:this}},n={xtype:"rallyfieldvaluecombobox",fieldLabel:"Exclude Story States",id:"excludedScheduleStatesComboBox",defaultSelectionPosition:"none",multiSelect:!0,hidden:!0,model:"HierarchicalRequirement",field:"ScheduleState",scope:this,listeners:{change:function(e){console.log("Story State: ",e.lastSelection),this._featureStateExclude=e.lastSelection},scope:this}},l={xtype:"rallyfieldvaluecombobox",fieldLabel:"Exclude Dependent Story States",id:"excludedDependentScheduleStatesComboBox",defaultSelectionPosition:"none",multiSelect:!0,hidden:!0,model:"HierarchicalRequirement",field:"ScheduleState",scope:this,listeners:{change:function(e){console.log("Dependent Story State: ",e.lastSelection),this._dependentFeatureStateExclude=e.lastSelection},scope:this}},s=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch()}});this.down("#header").add([{xtype:"panel",id:"filterPanel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Filter:",id:"innerFilterPanel",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"radiogroup",id:"featureStoriesRadioGroup",items:[{xtype:"radiofield",id:"radio1",name:"parameter",boxLabel:"Features",checked:!0,padding:"0 10 0 0",inputValue:"f"},{id:"radio2",name:"parameter",boxLabel:"Stories",padding:"0 10 0 0",inputValue:"s"}],listeners:{change:function(e,o,r){var n=o.parameter;this._searchParameter=n,console.log("value radio:",n);var l=Ext.ComponentQuery.query("#storiesRadioFilter")[0];"f"===n?(t.show(),a.hide(),l.hide(),Ext.ComponentQuery.query("#excludedStatesComboBox")[0].show(),Ext.ComponentQuery.query("#excludedDependentStatesComboBox")[0].show(),Ext.ComponentQuery.query("#excludedScheduleStatesComboBox")[0].hide(),Ext.ComponentQuery.query("#excludedDependentScheduleStatesComboBox")[0].hide(),Ext.ComponentQuery.query("#excludedScheduleStatesComboBox")[0].setValue(),Ext.ComponentQuery.query("#excludedDependentScheduleStatesComboBox")[0].setValue()):"s"===n?(l.show(),Ext.ComponentQuery.query("#releaseRadio")[0].setValue("r"),Ext.ComponentQuery.query("#excludedStatesComboBox")[0].hide(),Ext.ComponentQuery.query("#excludedDependentStatesComboBox")[0].hide(),Ext.ComponentQuery.query("#excludedScheduleStatesComboBox")[0].show(),Ext.ComponentQuery.query("#excludedDependentScheduleStatesComboBox")[0].show(),Ext.ComponentQuery.query("#excludedStatesComboBox")[0].setValue(),Ext.ComponentQuery.query("#excludedDependentStatesComboBox")[0].setValue()):(t.hide(),a.hide(),l.hide())},scope:this}},o,r,n,l,{xtype:"radiogroup",id:"storiesRadioFilter",fieldLabel:"Choose",columns:2,vertical:!0,items:[{boxLabel:"Release",id:"releaseRadio",name:"storiesFilter",padding:"0 10 0 0",inputValue:"r"},{boxLabel:"Iteration",id:"iteartionRadio",name:"storiesFilter",padding:"0 10 0 0",inputValue:"i"}],listeners:{change:function(e,o,r){var n=o.storiesFilter;this._storiesFilter=n,console.log("value radio:",n),"r"===n?(t.show(),a.hide()):"i"===n?(t.hide(),a.show()):(t.hide(),a.hide())},scope:this}}]}]},{xtype:"panel",items:[t,a,s]}]),Ext.ComponentQuery.query("#storiesRadioFilter")[0].hide(),a.hide()},_doSearch:function(){this.down("#bodyContainer").removeAll(),this.myMask.show();var e=this._getTypes(),t=this._getFilters();console.log("filters for search",t),Ext.create("Rally.data.wsapi.artifact.Store",{models:e,filters:t,fetch:["Name","FormattedID","ScheduleState","State","PercentDoneByStoryPlanEstimate","Release","Owner","Project","Predecessors","Successors"],limit:1/0,context:{project:"/project/"+this._projectId,projectScopeUp:!1,projectScopeDown:!0},sorters:[{property:"FormattedID",direction:"ASC"}]}).load().then({success:function(e){if(console.log("records",e),e&&e.length>0){var t=[];_.each(e,function(e){var a=e.get("Predecessors"),o=a.Count,r=e.get("Successors"),n=r.Count;if(a&&o>0){var l=Ext.create("Deft.Deferred");t.push(l);var s=this._loadPredecessors(e);Deft.Promise.all(s).then({success:function(t){console.log("p loaded for:",a),"empty"!==t[0]&&(e.get("Predecessors").data=t),l.resolve()},failure:function(e){console.log("error:",e)},scope:this})}if(r&&n>0){var i=Ext.create("Deft.Deferred");t.push(i);var d=this._loadSuccessors(e);console.log("creating call to load successors for",d,r),Deft.Promise.all(d).then({success:function(t){console.log("s loaded for:",t,r),"empty"!==t[0]&&(e.get("Successors").data=t),i.resolve()},failure:function(e){console.log("error:",e)},scope:this})}},this),Deft.Promise.all(t).then({success:function(){console.log("all artifacts loaded with predecessors and successors"),this.myMask.hide(),this._createGrid(e)},failure:function(e){console.log("error:",e)},scope:this})}else this.myMask.hide()},scope:this})},_getTypes:function(){var e=[];return"f"===this._searchParameter?e.push("PortfolioItem/Feature"):e.push("HierarchicalRequirement"),e},_getFilters:function(){var e,t=Ext.create("Rally.data.QueryFilter",{property:"Predecessors.ObjectID",operator:"!=",value:"null"}),a=Ext.create("Rally.data.QueryFilter",{property:"Successors.ObjectID",operator:"!=",value:"null"}),o=t.or(a);"f"===this._searchParameter?e=Ext.create("Rally.data.QueryFilter",{property:"Release.name",operator:"=",value:this._releaseName}):e="r"===this._storiesFilter?Ext.create("Rally.data.QueryFilter",{property:"Release.name",operator:"=",value:this._releaseName}):Ext.create("Rally.data.QueryFilter",{property:"Iteration.Name",operator:"=",value:this._iterationName});if("f"===this._searchParameter&&this._featureStateExclude&&this._featureStateExclude.length>0){console.log("exclude filters:",this._featureStateExclude);var r=this._getExcludadeFeatureStateFilter();_.each(r,function(e){o=o.and(e)},this)}if("s"===this._searchParameter&&this._featureStateExclude&&this._featureStateExclude.length>0){console.log("exclude story filters:",this._featureStateExclude);r=this._getExcludadeStoryScheduleStateFilter();_.each(r,function(e){o=o.and(e)},this)}return e.and(o)},_createGrid:function(e){console.log("Creating grid with artifacts",e);var t=[];"f"===this._searchParameter?_.each(e,function(e){e.get("Predecessors")&&e.get("Predecessors").data&&_.each(e.get("Predecessors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Release:e.get("Release")?e.get("Release").Name:"",State:e.get("State")?e.get("State").Name:"",PercentDoneByStoryPlanEstimate:e.get("PercentDoneByStoryPlanEstimate"),Project:e.get("Project").Name,Type:"P",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),DependentPercentDoneByStoryPlanEstimate:a.get("PercentDoneByStoryPlanEstimate"),DependentProject:a.get("Project").Name,DependentRelease:a.get("Release")?a.get("Release").Name:"",DependentState:a.get("State")?a.get("State").Name:""})},this),e.get("Successors")&&e.get("Successors").data&&_.each(e.get("Successors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Release:e.get("Release")?e.get("Release").Name:"",State:e.get("State")?e.get("State").Name:"",PercentDoneByStoryPlanEstimate:e.get("PercentDoneByStoryPlanEstimate"),Project:e.get("Project").Name,Type:"S",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),DependentPercentDoneByStoryPlanEstimate:a.get("PercentDoneByStoryPlanEstimate"),DependentProject:a.get("Project").Name,DependentRelease:a.get("Release")?a.get("Release").Name:"",DependentState:a.get("State")?a.get("State").Name:""})},this)},this):_.each(e,function(e){e.get("Predecessors")&&e.get("Predecessors").data&&_.each(e.get("Predecessors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Release:e.get("Release")?e.get("Release").Name:"",Iteration:e.get("Iteration")?e.get("Iteration").Name:"",State:e.get("ScheduleState"),Project:e.get("Project").Name,Type:"P",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),DependentProject:a.get("Project").Name,DependentRelease:a.get("Release")?a.get("Release").Name:"",DependentIteration:a.get("Iteration")?a.get("Iteration").Name:"",DependentState:a.get("ScheduleState")?a.get("ScheduleState"):""})},this),e.get("Successors")&&e.get("Successors").data&&_.each(e.get("Successors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Release:e.get("Release")?e.get("Release").Name:"",Iteration:e.get("Iteration")?e.get("Iteration").Name:"",State:e.get("ScheduleState"),Project:e.get("Project").Name,Type:"S",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),DependentProject:a.get("Project").Name,DependentRelease:a.get("Release")?a.get("Release").Name:"",DependentIteration:a.get("Iteration")?a.get("Iteration").Name:"",DependentState:a.get("ScheduleState")?a.get("ScheduleState"):""})},this)},this);var a,o,r=Ext.create("Ext.data.JsonStore",{fields:["FormattedID","Type","Project","State","Release","Iteration","DependentFeature","PercentDoneByStoryPlanEstimate","DependentProject","DependentState","DependentPercentDoneByStoryPlanEstimate","DependentIteration","DependentRelease"],data:t});a="f"===this._searchParameter?[{text:"Feature #",dataIndex:"FormattedID",flex:3},{text:"Feature State",dataIndex:"State",flex:1},{text:"Feature Project",dataIndex:"Project",flex:1},{text:"Percent Done By Story PlanEstimate",dataIndex:"PercentDoneByStoryPlanEstimate",flex:2,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate",{isClickable:!1,showDangerNotificationFn:function(){return!1}})},{text:"Dependent P/S",dataIndex:"Type",flex:1},{text:"Dependent Feature #",dataIndex:"DependentFeature",flex:3},{text:"Dependent Feature Percent Done By Story PlanEstimate",dataIndex:"DependentPercentDoneByStoryPlanEstimate",flex:2,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate",{isClickable:!1,percentDoneName:"DependentPercentDoneByStoryPlanEstimate",showDangerNotificationFn:function(){return!1}})},{text:"Dependent Project",dataIndex:"DependentProject",flex:1},{text:"Dependent Release",dataIndex:"DependentRelease",flex:1},{text:"Dependent State",dataIndex:"DependentState",flex:1}]:[{text:"Story #",dataIndex:"FormattedID",flex:3},{text:"Story State",dataIndex:"State",flex:1},{text:"Story Project",dataIndex:"Project",flex:1},{text:"Dependent P/S",dataIndex:"Type",flex:1},{text:"Dependent Story #",dataIndex:"DependentFeature",flex:3},{text:"Dependent Project",dataIndex:"DependentProject",flex:1},{text:"Dependent Release",dataIndex:"DependentRelease",flex:1},{text:"Dependent Iteration",dataIndex:"DependentIteration",flex:1},{text:"Dependent State",dataIndex:"DependentState",flex:1}],o=Ext.create("Ext.grid.Panel",{itemId:"featuresGrid",store:r,viewConfig:{enableTextSelection:!0,listeners:{viewready:function(e){console.log("viewready, view"),this._updateRowSpan(a,o,r)},sortchange:function(e,t){console.log("sort change, view"),console.log("ext calling update rowspan",a),console.log("ext calling update rowspan",o),console.log("ext calling update rowspan",r),this._updateRowSpan(a,o,r)},scope:this}},listeners:{sortchange:function(e,t){console.log("sort change, grid"),console.log("ext calling update rowspan",a),console.log("ext calling update rowspan",o),console.log("ext calling update rowspan",r),this._updateRowSpan(a,o,r)},scope:this},columns:a});var n={xtype:"panel",id:"predSuccFilterPanel",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"radiogroup",id:"predSuccFilterRadio",fieldLabel:"Choose filter",columns:3,vertical:!0,items:[{xtype:"radiofield",id:"radiop",name:"psaFilter",boxLabel:"Predecessors",padding:"0 10 0 0",inputValue:"p"},{id:"radios",name:"psaFilter",boxLabel:"Successors",padding:"0 10 0 0",inputValue:"s"},{id:"radioa",name:"psaFilter",boxLabel:"All",cheked:!0,padding:"0 10 0 0",inputValue:"a"}],listeners:{change:function(e,t,n){var l=t.psaFilter;console.log("value radio:",l),"p"===l?(r.clearFilter(!0),r.filter("Type","P")):"s"===l?(r.clearFilter(!0),r.filter("Type","S")):r.clearFilter(!1),this._updateRowSpan(a,o,r)},scope:this}}]},l=Ext.create("Rally.ui.Button",{text:"Export",margin:"10 10 10 10",scope:this,handler:function(){var e=this._convertToCSV(t);console.log("converting to csv:",e);var a=document.createElement("a"),o=new Blob(["\ufeff",e]),r=URL.createObjectURL(o);a.href=r,a.download="report.csv",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}),s=Ext.create("Ext.panel.Panel",{title:"TEAMS WORK ITEMS AND ALIGNED DEPENDENCIES",autoScroll:!0,layout:{type:"vbox",align:"stretch"},items:[n,o]});this.down("#bodyContainer").add(s),this.down("#bodyContainer").add(l)},_updateRowSpan:function(e,t,a){e=e;for(var o=t.getView(),r=(a=a).getCount(),n=e[0].dataIndex,l=null,s=null,i=null,d=null,c=null,u=0;u<r;++u){var p=o.getCellByPosition({row:u,column:0}).dom,h=o.getCellByPosition({row:u,column:1}).dom,S=o.getCellByPosition({row:u,column:2}).dom,m=a.getAt(u).get(n);c!==m?(null!==l&&(l.rowSpan=d,s.rowSpan=d,i.rowSpan=d),Ext.fly(p).setStyle("display",""),Ext.fly(p).setStyle("vertical-align","middle"),Ext.fly(h).setStyle("display",""),Ext.fly(h).setStyle("vertical-align","middle"),Ext.fly(S).setStyle("display",""),Ext.fly(S).setStyle("vertical-align","middle"),l=p,s=h,i=S,d=1,c=m):(d++,Ext.fly(p).setStyle("display","none"),Ext.fly(h).setStyle("display","none"),Ext.fly(S).setStyle("display","none"))}null!==l&&(l.rowSpan=d,s.rowSpan=d,i.rowSpan=d)},_getExcludadeFeatureStateFilter:function(){console.log("exclude filters:",this._featureStateExclude);var e=[];return _.each(this._featureStateExclude,function(t){var a=t.get("name");if("-- No Entry --"!==a){var o=Ext.create("Rally.data.QueryFilter",{property:"State",operator:"!=",value:a});e.push(o)}},this),e},_getExcludadeStoryScheduleStateFilter:function(){var e=[];return _.each(this._featureStateExclude,function(t){var a=t.get("name");if(a){var o=Ext.create("Rally.data.QueryFilter",{property:"ScheduleState",operator:"!=",value:a});e.push(o)}},this),console.log("exclude story filters:",e),e},_getDependentExcludadeFeatureStateFilter:function(){console.log("exclude dependent filters:",this._dependentFeatureStateExclude);var e=[];return _.each(this._dependentFeatureStateExclude,function(t){var a=t.get("name");if("-- No Entry --"!==a){var o=Ext.create("Rally.data.QueryFilter",{property:"State",operator:"!=",value:a});e.push(o)}},this),console.log("exclude dependent feature filters:",e),e},_getDependentExcludadeStoryScheduleStateFilter:function(){console.log("exclude dependent filters:",this._dependentFeatureStateExclude);var e=[];return _.each(this._dependentFeatureStateExclude,function(t){var a=t.get("name");if(a){var o=Ext.create("Rally.data.QueryFilter",{property:"ScheduleState",operator:"!=",value:a});e.push(o)}},this),console.log("exclude dependent story filters:",e),e},_loadPredecessors:function(e){var t=Ext.create("Deft.Deferred"),a=[];return"f"==this._searchParameter&&this._dependentFeatureStateExclude&&(a=this._getDependentExcludadeFeatureStateFilter()),"s"==this._searchParameter&&this._dependentFeatureStateExclude&&(a=this._getDependentExcludadeStoryScheduleStateFilter()),e.getCollection("Predecessors").load({fetch:["Name","FormattedID","ScheduleState","State","Project","PlanEstimate","PercentDoneByStoryPlanEstimate","LeafStoryPlanEstimateTotal","Release","Iteration"],filters:a,scope:this,callback:function(e,a,o){console.log("predecessor loaded:",e),e.length>0?t.resolve(e):t.resolve(["empty"])}}),t.promise},_loadSuccessors:function(e){var t=Ext.create("Deft.Deferred"),a=[];return"f"==this._searchParameter&&this._dependentFeatureStateExclude&&(a=this._getDependentExcludadeFeatureStateFilter()),"s"==this._searchParameter&&this._dependentFeatureStateExclude&&(a=this._getDependentExcludadeStoryScheduleStateFilter()),e.getCollection("Successors").load({fetch:["Name","FormattedID","ScheduleState","State","Project","PlanEstimate","LeafStoryPlanEstimateTotal","PercentDoneByStoryPlanEstimate","Release","Iteration"],filters:a,scope:this,callback:function(e,a,o){console.log("successor loaded:",e),e.length>0?t.resolve(e):t.resolve(["empty"])}}),t.promise},_convertToCSV:function(e){var t=Object.keys(e[0]),a=function(e,t){return null===t?"":t},o=e.map(function(e){return t.map(function(t){return JSON.stringify(e[t],a)}).join(",")});return o.unshift(t.join(",")),o.join("\r\n")}});

            Rally.launchApp('CustomApp', {
                name:"S725076-Dependency-Report",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .grid-row-span .x-grid3-row{border-bottom:0}.grid-row-span .x-grid3-col{border-bottom:1px solid #ededed}.grid-row-span .row-span{border-bottom:1px solid #fff}.grid-row-span .row-span-first{position:relative}.grid-row-span .row-span-first .x-grid3-cell-inner{position:absolute}.grid-row-span .row-span-last{border-bottom:1px solid #ededed}
    </style>
</head>
<body>
</body>
</html>
