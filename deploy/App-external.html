<!DOCTYPE html>
<html>
<head>
    <title>S725076-Dependency-Report</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_projectId:void 0,_mapProjects:void 0,_releaseId:void 0,_releaseName:void 0,_iterationId:void 0,_iterationName:void 0,_searchParameter:"f",_storiesFilter:void 0,_featureStateExclude:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;this._projectId=e,console.log("Project:",this._projectId),this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this});var t=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:400,itemId:"releasaeComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._releaseId=t.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},select:function(e,t){var a=t[0];this._releaseId=a.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},scope:this}}),a=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Choose Iteration",width:400,itemId:"iterationComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._iterationId=t.get("ObjectID"),this._iterationName=t.get("Name")},select:function(e,t,a){var o=t[0];this._iterationId=o.get("ObjectID"),this._iterationName=o.get("Name")},scope:this}}),o={xtype:"rallyfieldvaluecombobox",fieldLabel:"Exclude Feature States",model:"PortfolioItem/Feature",field:"State",scope:this,listeners:{change:function(e){console.log("Feature State: ",e.getRawValue()),this._featureStateExclude=e.getValue()},scope:this}},r=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch()}});this.down("#header").add([{xtype:"panel",id:"filterPanel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Filter:",id:"innerFilterPanel",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"radiogroup",id:"featureStoriesRadioGroup",items:[{xtype:"radiofield",id:"radio1",name:"parameter",boxLabel:"Features",checked:!0,padding:"0 10 0 0",inputValue:"f"},{id:"radio2",name:"parameter",boxLabel:"Stories",padding:"0 10 0 0",inputValue:"s"}],listeners:{change:function(e,o,r){var s=o.parameter;this._searchParameter=s,console.log("value radio:",s);var n=Ext.ComponentQuery.query("#storiesRadioFilter")[0];"f"===s?(t.show(),a.hide(),n.hide()):"s"===s?(n.show(),Ext.ComponentQuery.query("#releaseRadio")[0].setValue("r")):(t.hide(),a.hide(),n.hide())},scope:this}},o,{xtype:"radiogroup",id:"storiesRadioFilter",fieldLabel:"Choose",columns:2,vertical:!0,items:[{boxLabel:"Release",id:"releaseRadio",name:"storiesFilter",padding:"0 10 0 0",inputValue:"r"},{boxLabel:"Iteration",id:"iteartionRadio",name:"storiesFilter",padding:"0 10 0 0",inputValue:"i"}],listeners:{change:function(e,o,r){var s=o.storiesFilter;this._storiesFilter=s,console.log("value radio:",s),"r"===s?(t.show(),a.hide()):"i"===s?(t.hide(),a.show()):(t.hide(),a.hide())},scope:this}}]}]},{xtype:"panel",items:[t,a,r]}]),Ext.ComponentQuery.query("#storiesRadioFilter")[0].hide(),a.hide()},_doSearch:function(){this.myMask.show();var e=this._getTypes(),t=this._getFilters();Ext.create("Rally.data.wsapi.artifact.Store",{models:e,filters:t,fetch:["Name","FormattedID","ScheduleState","State","Release","Owner","Project","Predecessors","Successors"],limit:1/0,context:{project:"/project/"+this._projectId,projectScopeUp:!1,projectScopeDown:!0},sorters:[{property:"FormattedID",direction:"ASC"}]}).load().then({success:function(e){if(console.log("records",e),e&&e.length>0){var t=[];_.each(e,function(e){var a=e.get("Predecessors"),o=a.Count,r=e.get("Successors"),s=r.Count;if(a&&o>0){var n=Ext.create("Deft.Deferred");t.push(n);var l=this._loadPredecessors(e);Deft.Promise.all(l).then({success:function(t){console.log("p loaded for:",a),"empty"!==t[0]&&(e.get("Predecessors").data=t),n.resolve()},failure:function(e){console.log("error:",e)},scope:this})}if(r&&s>0){var i=Ext.create("Deft.Deferred");t.push(i);var d=this._loadSuccessors(e);console.log("creating call to load successors for",d,r),Deft.Promise.all(d).then({success:function(t){console.log("s loaded for:",t,r),"empty"!==t[0]&&(e.get("Successors").data=t),i.resolve()},failure:function(e){console.log("error:",e)},scope:this})}},this),Deft.Promise.all(t).then({success:function(){console.log("all artifacts loaded with predecessors and successors"),this.myMask.hide(),this._createGrid(e)},failure:function(e){console.log("error:",e)},scope:this})}else this.myMask.hide()},scope:this})},_getTypes:function(){var e=[];return"f"===this._searchParameter?e.push("PortfolioItem/Feature"):e.push("HierarchicalRequirement"),e},_getFilters:function(){var e,t;"f"===this._searchParameter?e=Ext.create("Rally.data.QueryFilter",{property:"Release.name",operator:"=",value:this._releaseName}):e="r"===this._storiesFilter?Ext.create("Rally.data.QueryFilter",{property:"Release.name",operator:"=",value:this._releaseName}):Ext.create("Rally.data.QueryFilter",{property:"Iteration.Name",operator:"=",value:this._iterationName});this._featureStateExclude&&"-- No Entry --"!==this._featureStateExclude&&(t=Ext.create("Rally.data.QueryFilter",{property:"State",operator:"!=",value:this._featureStateExclude}));var a=Ext.create("Rally.data.QueryFilter",{property:"Predecessors.ObjectID",operator:"!=",value:"null"});return"f"===this._searchParameter&&t&&(e=e.and(t)),e.and(a)},_createGrid:function(e){console.log("Creating grid with artifacts",e),this.down("#bodyContainer").removeAll();var t=[];"f"===this._searchParameter?_.each(e,function(e){e.get("Predecessors")&&e.get("Predecessors").data&&_.each(e.get("Predecessors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Release:e.get("Release")?e.get("Release").Name:"",State:e.get("State").Name,Project:e.get("Project").Name,Type:"P",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),DependentProject:a.get("Project").Name,DependentRelease:a.get("Release")?a.get("Release").Name:"",DependentState:a.get("State")?a.get("State").Name:""})},this),e.get("Successors")&&e.get("Successors").data&&_.each(e.get("Successors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Release:e.get("Release")?e.get("Release").Name:"",State:e.get("State").Name,Project:e.get("Project").Name,Type:"S",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),DependentProject:a.get("Project").Name,DependentRelease:a.get("Release")?a.get("Release").Name:"",DependentState:a.get("State")?a.get("State").Name:""})},this)},this):_.each(e,function(e){e.get("Predecessors")&&e.get("Predecessors").data&&_.each(e.get("Predecessors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Release:e.get("Release")?e.get("Release").Name:"",Iteration:e.get("Iteration")?e.get("Iteration").Name:"",State:e.get("ScheduleState"),Project:e.get("Project").Name,Type:"P",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),DependentProject:a.get("Project").Name,DependentRelease:a.get("Release")?a.get("Release").Name:"",DependentIteration:a.get("Iteration")?a.get("Iteration").Name:"",DependentState:a.get("ScheduleState")?a.get("ScheduleState"):""})},this),e.get("Successors")&&e.get("Successors").data&&_.each(e.get("Successors").data,function(a){t.push({FormattedID:e.get("FormattedID")+" - "+e.get("Name"),Release:e.get("Release")?e.get("Release").Name:"",Iteration:e.get("Iteration")?e.get("Iteration").Name:"",State:e.get("ScheduleState"),Project:e.get("Project").Name,Type:"S",DependentFeature:a.get("FormattedID")+" - "+a.get("Name"),DependentProject:a.get("Project").Name,DependentRelease:a.get("Release")?a.get("Release").Name:"",DependentIteration:a.get("Iteration")?a.get("Iteration").Name:"",DependentState:a.get("ScheduleState")?a.get("ScheduleState"):""})},this)},this);var a,o,r=Ext.create("Ext.data.JsonStore",{fields:["FormattedID","Type","Project","State","Release","Iteration","DependentFeature","DependentProject","DependentState","DependentIteration","DependentRelease"],data:t});a="f"===this._searchParameter?[{text:"Feature #",dataIndex:"FormattedID",flex:3},{text:"Feature State",dataIndex:"State",flex:1},{text:"Feature Project",dataIndex:"Project",flex:1},{text:"Dependent P/S",dataIndex:"Type",flex:1},{text:"Dependent Feature #",dataIndex:"DependentFeature",flex:3},{text:"Dependent Project",dataIndex:"DependentProject",flex:1},{text:"Dependent Release",dataIndex:"DependentRelease",flex:1},{text:"Dependent State",dataIndex:"DependentState",flex:1}]:[{text:"Story #",dataIndex:"FormattedID",flex:3},{text:"Story State",dataIndex:"State",flex:1},{text:"Story Project",dataIndex:"Project",flex:1},{text:"Dependent P/S",dataIndex:"Type",flex:1},{text:"Dependent Story #",dataIndex:"DependentFeature",flex:3},{text:"Dependent Project",dataIndex:"DependentProject",flex:1},{text:"Dependent Release",dataIndex:"DependentRelease",flex:1},{text:"Dependent Iteration",dataIndex:"DependentIteration",flex:1},{text:"Dependent State",dataIndex:"DependentState",flex:1}],o=Ext.create("Ext.grid.Panel",{itemId:"featuresGrid",store:r,viewConfig:{enableTextSelection:!0,listeners:{viewready:function(e){console.log("viewready, view"),this._updateRowSpan(a,o,r)},sortchange:function(e,t){console.log("sort change, view"),console.log("ext calling update rowspan",a),console.log("ext calling update rowspan",o),console.log("ext calling update rowspan",r),this._updateRowSpan(a,o,r)},scope:this}},listeners:{sortchange:function(e,t){console.log("sort change, grid"),console.log("ext calling update rowspan",a),console.log("ext calling update rowspan",o),console.log("ext calling update rowspan",r),this._updateRowSpan(a,o,r)},scope:this},columns:a});var s={xtype:"panel",id:"predSuccFilterPanel",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"radiogroup",id:"predSuccFilterRadio",fieldLabel:"Choose filter",columns:3,vertical:!0,items:[{xtype:"radiofield",id:"radiop",name:"psaFilter",boxLabel:"Predecessors",padding:"0 10 0 0",inputValue:"p"},{id:"radios",name:"psaFilter",boxLabel:"Successors",padding:"0 10 0 0",inputValue:"s"},{id:"radioa",name:"psaFilter",boxLabel:"All",cheked:!0,padding:"0 10 0 0",inputValue:"a"}],listeners:{change:function(e,t,s){var n=t.psaFilter;console.log("value radio:",n),"p"===n?(r.clearFilter(!0),r.filter("Type","P")):"s"===n?(r.clearFilter(!0),r.filter("Type","S")):r.clearFilter(!1),this._updateRowSpan(a,o,r)},scope:this}}]},n=Ext.create("Rally.ui.Button",{text:"Export",margin:"10 10 10 10",scope:this,handler:function(){var e=this._convertToCSV(t);console.log("converting to csv:",e);var a=document.createElement("a"),o=new Blob(["\ufeff",e]),r=URL.createObjectURL(o);a.href=r,a.download="report.csv",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}),l=Ext.create("Ext.panel.Panel",{title:"TEAMS WORK ITEMS AND ALIGNED DEPENDENCIES",autoScroll:!0,layout:{type:"vbox",align:"stretch"},padding:5,items:[s,o]});this.down("#bodyContainer").add(l),this.down("#bodyContainer").add(n)},_updateRowSpan:function(e,t,a){e=e;for(var o=t.getView(),r=(a=a).getCount(),s=e[0].dataIndex,n=null,l=null,i=null,d=null,c=null,p=0;p<r;++p){var u=o.getCellByPosition({row:p,column:0}).dom,h=o.getCellByPosition({row:p,column:1}).dom,g=o.getCellByPosition({row:p,column:2}).dom,m=a.getAt(p).get(s);c!==m?(null!==n&&(n.rowSpan=d,l.rowSpan=d,i.rowSpan=d),Ext.fly(u).setStyle("display",""),Ext.fly(u).setStyle("vertical-align","middle"),Ext.fly(h).setStyle("display",""),Ext.fly(h).setStyle("vertical-align","middle"),Ext.fly(g).setStyle("display",""),Ext.fly(g).setStyle("vertical-align","middle"),n=u,l=h,i=g,d=1,c=m):(d++,Ext.fly(u).setStyle("display","none"),Ext.fly(h).setStyle("display","none"),Ext.fly(g).setStyle("display","none"))}null!==n&&(n.rowSpan=d,l.rowSpan=d,i.rowSpan=d)},_loadPredecessors:function(e){var t=Ext.create("Deft.Deferred"),a=[];return"f"==this._searchParameter&&this._featureStateExclude&&"-- No Entry --"!=this._featureStateExclude&&(a=[{property:"State",operator:"!=",value:this._featureStateExclude}]),e.getCollection("Predecessors").load({fetch:["Name","FormattedID","ScheduleState","State","Project","PlanEstimate","LeafStoryPlanEstimateTotal","Release","Iteration"],filters:a,scope:this,callback:function(e,a,o){console.log("predecessor loaded:",e),e.length>0?t.resolve(e):t.resolve(["empty"])}}),t.promise},_loadSuccessors:function(e){var t=Ext.create("Deft.Deferred"),a=[];return"f"==this._searchParameter&&this._featureStateExclude&&"-- No Entry --"!=this._featureStateExclude&&(a=[{property:"State",operator:"!=",value:this._featureStateExclude}]),e.getCollection("Successors").load({fetch:["Name","FormattedID","ScheduleState","State","Project","PlanEstimate","LeafStoryPlanEstimateTotal","Release","Iteration"],filters:a,scope:this,callback:function(e,a,o){console.log("successor loaded:",e),e.length>0?t.resolve(e):t.resolve(["empty"])}}),t.promise},_convertToCSV:function(e){var t=Object.keys(e[0]),a=function(e,t){return null===t?"":t},o=e.map(function(e){return t.map(function(t){return JSON.stringify(e[t],a)}).join(",")});return o.unshift(t.join(",")),o.join("\r\n")}});

            Rally.launchApp('CustomApp', {
                name:"S725076-Dependency-Report",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .grid-row-span .x-grid3-row{border-bottom:0}.grid-row-span .x-grid3-col{border-bottom:1px solid #ededed}.grid-row-span .row-span{border-bottom:1px solid #fff}.grid-row-span .row-span-first{position:relative}.grid-row-span .row-span-first .x-grid3-cell-inner{position:absolute}.grid-row-span .row-span-last{border-bottom:1px solid #ededed}
    </style>
</head>
<body>
</body>
</html>
